<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ARIA DIV Table → CSV (Paste Only)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; }
    textarea { width: 100%; height: 250px; font-family: monospace; font-size: 14px; }
    button { padding: 10px 20px; margin-top: 10px; font-size: 16px; }
    .preview { white-space: pre; background:#f7f7f7; border:1px solid #ddd; padding:10px; margin-top:12px; max-height:300px; overflow:auto; }
  </style>
</head>
<body>
  <h1>ARIA DIV Table → CSV</h1>
  <p>Paste your HTML (full page or just the <code>&lt;div role="table"&gt;</code>) below, then click Convert.</p>
  <textarea id="htmlInput" placeholder="Paste HTML here..."></textarea>
  <br>
  <button id="btnConvert">Convert to CSV</button>

  <h3>Preview (first 10 lines)</h3>
  <div class="preview" id="preview"></div>

  <script>
    const csvEscape = s => {
      if (s == null) return '';
      s = String(s);
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    };

    // Strip commas in numbers like 1,234,567 but leave text unchanged
    const cleanNumber = val => {
      if (/^\d{1,3}(,\d{3})+$/.test(val)) {
        return val.replace(/,/g, '');
      }
      return val;
    };

    const toCSV = (headers, rows) => {
      const lines = [];
      if (headers?.length) lines.push(headers.map(csvEscape).join(','));
      for (const r of rows) {
        lines.push(r.map(v => csvEscape(cleanNumber(v))).join(','));
      }
      return lines.join('\n');
    };

    function deepText(el){
      if(!el) return '';
      const a = el.querySelector('a, kat-link');
      if (a) {
        const t = (a.textContent || '').replace(/\s+/g, ' ').trim();
        if (t) return t;
      }
      const clone = el.cloneNode(true);
      clone.querySelectorAll('script,style,svg,kat-icon').forEach(n => n.remove());
      return (clone.textContent || '').replace(/\s+/g, ' ').trim();
    }

    function extractHeaders(root){
      let headerHost = root.querySelector('.aba-header') || root;
      const headerRows = headerHost.querySelectorAll('[role="row"]');
      const headerRow = headerRows[headerRows.length - 1] || headerRows[0];
      if (!headerRow) return [];
      const cells = headerRow.querySelectorAll('[role="columnheader"], [colspan]');
      return Array.from(cells).map(c => deepText(c)).filter(Boolean);
    }

    function extractBody(root){
      let body = root.querySelector('[role="rowgroup"].body');
      if (!body) {
        const groups = root.querySelectorAll('[role="rowgroup"]');
        body = groups[groups.length - 1];
      }
      if (!body) return [];
      const rows = [];
      body.querySelectorAll('[role="row"]').forEach(row => {
        const cellDivs = row.querySelectorAll(':scope > div');
        const vals = Array.from(cellDivs).map(td => deepText(td));
        rows.push(vals);
      });
      return rows;
    }

    function normalize(headers, rows){
      if (!headers.length) {
        const n = rows.reduce((m,r)=>Math.max(m, r.length), 0);
        headers = Array.from({length:n}, (_,i)=>`col${i+1}`);
      }
      const n = headers.length;
      return rows.map(r => {
        const v = r.slice(0, n);
        while (v.length < n) v.push('');
        return v;
      });
    }

    document.getElementById('btnConvert').addEventListener('click', () => {
      const html = document.getElementById('htmlInput').value.trim();
      if (!html) { alert('Paste HTML first.'); return; }

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const root = doc.querySelector('div[role="table"], div.table.sticky');
      if (!root) { alert('No ARIA table found in the pasted HTML.'); return; }

      let headers = extractHeaders(root);
      let rows = extractBody(root);
      rows = normalize(headers, rows);

      const csv = toCSV(headers, rows);
      document.getElementById('preview').textContent = csv.split('\n').slice(0,10).join('\n');

      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'table.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
